---
title: "Model for End-stage Liver Disease eXcluding INR (MELD-XI) score predicts outcomes in pediatric patients supported with Ventricular Assist Device: An analysis of the PediMACS registry"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: united
---
Stastician: Devin Koehl

```{r, echo=FALSE, include=FALSE}
library(DiagrammeR)
library(haven)
library(arsenal)
library(KableOne)
library(tidyverse)
library(Hmisc)
library(kableExtra)
library(survival)
library(survminer)
library(dplyr)
```

# NOTE TO DO: Need to clean up and make repeated code functions

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<center>
![](logo.jpg){width=400px}
</center>

# What is Pedimacs?

Pedimacs is a pediatric registry that collects data on patients receiving a ventricular assist device (VAD) that are <19 years of age. It is the pediatric portion to Intermacs, which is the adult database collecting data on patients >19 years old. While Intermacs has always included durable devices implanted in pediatric patients, Pedimacs has been developed to focus on capturing data elements unique to pediatric patients. Pedimacs evaluates special issues in the pediatric population receiving Mechanical Circulatory Support Device (MCSD) therapy, differences in devices available, and the particular pediatric population for whom this therapy may be most effective.

# Proposal Research Question

We want to evaluate the utility of pre-implant MELD-XI score in identifying pediatric patients at higher risk for morbidity and mortality post-ventricular assist device (VAD) implant.

# MELD-XI Score

MELD, the Model for End Stage Liver Disease Excluding INR (MELD-XI), and is calculated by using transformations of patients bilirubin and creatinine. A high MELD-XI score is seen as bad liver dysfunction, while a low MELD-XI score is screen as good liver function.

The equation used to calculate the MELD-XI score is as follows:

MELD-XI= 5.112 x ln (total bilirubin) + 11.76 x ln(creatinine) + 9.44.

Creatinine and total bilirubin will be measured as mg/dl. As previously described, creatinine and total bilirubin values <1 mg/dl will be set to 1 mg/dl for the purpose of calculating MELD-XI score to avoid negative values after natural logarithmic transformation. Conversely, creatinine will be set at 4 mg/dl for patients with measured creatinine values >4 mg/dl or in those receiving renal replacement therapy thus making 9.44 the lowest obtainable MELD-XI.

We will then classify those with a pre- VAD MELD-XI score below the 25th percentile of the entire cohort as the low MELD-XI score cohort, those between the 25th- 75thpercentile of the entire cohort as the intermediate MELD-XI score cohort, and those above the 75th percentile as the high MELD-XI score cohort.

# Project Background

Congestive hepatopathy is often seen in patients with end stage heart failure. This is due to a combination of decreased cardiac output and passive venous congestion secondary to increased systemic venous pressure. Patients with advanced liver disease are at an increased risk for mortality after cardiac surgery and even after heart transplantation. Originally developed to predict mortality in patients being considered for transjugular intrahepatic portosystemic shunt placement, and subsequently in patients with end-stage liver disease, a high Model for End-stage Liver Disease (MELD) score has been demonstrated to correlate with worse post-implant outcomes (morbidity and mortality) in adults undergoing VAD placement. The MELD eXcluding INR (MELD-XI score), which omits INR from the calculation, is as accurate in predicting short-term survival in patients with liver cirrhosis and has been validated against the original MELD score. The MELD-XI score may potentially be a more effective method of estimating liver dysfunction in patients on VAD support requiring concomitant oral anticoagulation (as it doesn’t include INR in its calculation). In adults, higher VAD pre-implant MELD-XI scores predicts higher morbidity and mortality post-implant and post-transplantation. While the use of VADs in pediatric patients has clearly increased over the last decade,VAD and patient selection remains a complex task in this population. To date, there have been no large scale pediatric studies assessing the utility of the MELD-XI score in predicting post-VAD implant outcomes (morbidity and mortality). By utilizing this score (MELD-XI) we aim to identify pediatric patients at higher risk for adverse events post-VAD implant.

# Proposal Inclusion Criteria 

* Inclusion Criteria
  + Patients <19 years old at time of VAD Implant
  
* Exclusion Criteria
  + Patients with missing values that preclude calculation of a MELD-XI Score pre-VAD Implant

# Specific Aims

- Specific Aim #1: To compare baseline clinical, laboratory and hemodynamic characteristics of pediatric patients with low, intermediate and high MELD-XI scores.
- Specific Aim #2: To compare early (≤3 months) and late (>3months) post-VAD implant morbidity (length of stay, respiratory failure, bleeding, device malfunction, pump thrombosis, infection, neurological dysfunction, hepatic dysfunction and renal dysfunction) in pediatric patients with low, intermediate and high MELD-XI scores.
- Specific Aim #3: To compare early (≤3 months) and late (>3months) post-VAD implant survival in pediatric patients with low, intermediate and high MELD-XI scores.
- Specific Aim #4: To compare accuracy of MELD-XI score (which incorporates both bilirubin and creatinine) to bilirubin and creatinine in predicting 7-day, 30- day, 3-month and 6-month post-VAD mortality.

# Device Classification
- Paracorporeal Pulsatile
  + Berlin Heart EXCOR
  + Thoratec PVAD
  + Abiomed AB5000
- Paracorporeal Continuous
  + Thoratec Centrimag
  + Thoratec Pedimag
  + Maquet Rotaflow
  + Sorin Revolution
- Implantable Continuous
  + HeartWare HVAD
  + HeartMate II LVAS
  + HeartMate III
- TAH
  + SynCardia CardioWest TAH – 70cc
- Percutaneous
  + Abiomed Impella 2.5
  + TandemHeart
  + Abiomed Impella 5.0
  + Abiomed Impella CP

# Overall Research Cohort
```{r, echo=FALSE, include=TRUE}

grViz("digraph flowchart {
      # node definitions with substituted label text
       node [fontname = Helvetica, fontcolor = black,
        shape = rectangle, width = 1,
        color = darkslategray,fontsize=10]
      edge [color = black, arrowhead = none, arrowtail = none]
      tab1 [label = '@@1']
      tab2 [label = '@@2']
      tab3 [label = '@@3']
      tab4 [label = '@@4']
      tab5 [label = '@@5']
      tab6 [label = '@@6']

      # edge definitions with the node IDs
      tab1 -> {tab2 tab3 tab4 tab5 tab6};
      }

      [1]: 'All Primary Prospective Patients (Initial Device)\\n September 19, 2012-March 31,2019\\n N=685'
      [2]: 'Implantable Continuous\\n N=303'
      [3]: 'Paracorporeal Pulsatile\\n N=193'
      [4]: 'Paracorporeal Continuous\\n N=151'
      [5]: 'Percuteanous\\n N=34'
      [6]: 'TAH\\n N=4'
      ")


```

# MELD-XI Calculation

Since we will be using Creatinine (mg/dL) and Bilirubin (mg/dL) to calculate MELD-XI score, it is important to look at the coverage of these variables.

```{r, echo=FALSE, include=FALSE}

#Necessary libraries for project
library(DiagrammeR)
library(haven)
library(arsenal)
library(KableOne)
library(tidyverse)
library(Hmisc)
library(kableExtra)
library(survival)
library(survminer)
library(dplyr)

#Read in patient dataset
patients <- read_sas("analysis_format.sas7bdat")

#look at the variable types
glimpse(patients)



recodes_creat <- patients %>%
 summarise_at(
 vars(CREAT_MG_DL),
 funs(
 "Total N" = sum(!is.na(.)),
 
 "Missing" = sum(is.na(.)),
 
 "Mean" = round(mean(., na.rm=TRUE),2),
 
 "Median" = round(median(., na.rm=TRUE),2),
 
 "Standard Deviation" = round(sd(., na.rm=TRUE),2),
 
 "Min" = min(. ,na.rm=TRUE),
 
 "Max" = max(. ,na.rm=TRUE),
 
 "25th Percentile" = quantile(CREAT_MG_DL,probs=0.25,na.rm=TRUE),
 
 "75th Percentile" = quantile(CREAT_MG_DL,probs=0.75,na.rm=TRUE),
 
  "Percent Coverage" = round((sum(!is.na(.))/685)*100,2)
 
  
  )
  )%>%
  
  kable( caption= "Coverage of Creatinine") %>%
  
  kable_styling("striped",bootstrap_options = "basic",full_width = NULL) 


recodes_bili <- patients %>%
 summarise_at(
 vars(BILI_TOTAL_MG_DL),
 funs(
 "Total N" = sum(!is.na(.)),
 
 "Missing" = sum(is.na(.)),
 
 "Mean" = round(mean(., na.rm=TRUE),2),
 
 "Median" = round(median(., na.rm=TRUE),2),
 
 "Standard Deviation" = round(sd(., na.rm=TRUE),2),
 
 "Min" = min(. ,na.rm=TRUE),
 
 "Max" = max(. ,na.rm=TRUE),
 
 "25th Percentile" = quantile(BILI_TOTAL_MG_DL,probs=0.25,na.rm=TRUE),
 
 "75th Percentile" = quantile(BILI_TOTAL_MG_DL,probs=0.75,na.rm=TRUE),
 
  "Percent Coverage" = round((sum(!is.na(.))/685)*100,2)
 
  
  )
  )%>%
  
  kable( caption= "Coverage of Bilirubin") %>%
  
  kable_styling("striped",bootstrap_options = "basic",full_width = NULL) 



recodes_meld <- patients %>%
 summarise_at(
 vars(MELD_XI_SCORE),
 funs(
 "Total N" = sum(!is.na(.)),
 
 "Missing" = sum(is.na(.)),
 
 "Mean" = round(mean(., na.rm=TRUE),2),
 
 "Median" = round(median(., na.rm=TRUE),2),
 
 "Standard Deviation" = round(sd(., na.rm=TRUE),2),
 
 "Min" = min(. ,na.rm=TRUE),
 
 "Max" = max(. ,na.rm=TRUE),
 
 "25th Percentile" = quantile(MELD_XI_SCORE,probs=0.25,na.rm=TRUE),
 
 "75th Percentile" = quantile(MELD_XI_SCORE,probs=0.75,na.rm=TRUE),
 
  "Percent Coverage" = round((sum(!is.na(.))/685)*100,2)
 
  
  )
  )%>%
  
  kable( caption= "Coverage of MELD-XI Score") %>%
  
  kable_styling("striped",bootstrap_options = "basic",full_width = NULL) 

  recodes_meld

# var = los_d
# strata = diagnosis (could be none)
# fig_num
# fig_name
title = "CDF of Length of Stay for Creatinine"
subtitle = "MELD-XI Score"
caption = "ISHLT 2020"
lab_x = "Creatinine (mg/dL)"
lab_y = "Proportion of Patients"
leg_pos = c(0.8, 0.2)

ggplot(patients, aes(CREAT_MG_DL)) + stat_ecdf(pad = FALSE) +
  theme_bw() + geom_vline(xintercept=0.7, linetype="dashed") +
  labs(title = title,
       subtitle = subtitle,
       caption = caption,
       x = lab_x,
       y = lab_y
       ) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = leg_pos,
        legend.background = element_rect(color = "black"))

rm(caption)
rm(lab_x)
rm(lab_y)
rm(leg_pos)
rm(subtitle)
rm(title)



title = "CDF of MELD-XI Score"
subtitle = "MELD-XI Score"
caption = "ISHLT 2020"
lab_x = "MELD-XI Score"
lab_y = "Proportion of Patients"
leg_pos = c(0.8, 0.2)

ggplot(patients, aes(MELD_XI_SCORE)) + stat_ecdf(pad = FALSE) +
  theme_bw() + geom_vline(xintercept=0.7, linetype="dashed") +
  labs(title = title,
       subtitle = subtitle,
       caption = caption,
       x = lab_x,
       y = lab_y
       ) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = leg_pos,
        legend.background = element_rect(color = "black"))

rm(caption)
rm(lab_x)
rm(lab_y)
rm(leg_pos)
rm(subtitle)
rm(title)


```


<br>
<br>

## Coverage of Creatinine
```{r, echo=FALSE, include=TRUE}
recodes_creat
```
```{r echo=FALSE, warning=FALSE, include=TRUE}
title = "CDF of Length of Stay for Creatinine"
subtitle = "MELD-XI Score"
caption = "ISHLT 2020"
lab_x = "Creatinine (mg/dL)"
lab_y = "Proportion of Patients"
leg_pos = c(0.8, 0.2)

ggplot(patients, aes(CREAT_MG_DL)) + stat_ecdf(pad = FALSE) +
  theme_bw() + geom_vline(xintercept=0.7, linetype="dashed") +
  labs(title = title,
       subtitle = subtitle,
       caption = caption,
       x = lab_x,
       y = lab_y
       ) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = leg_pos,
        legend.background = element_rect(color = "black"))

  rm(caption)
  rm(lab_x)
  rm(lab_y)
  rm(leg_pos)
  rm(subtitle)
  rm(title)

```

## Coverage of Bilirubin
```{r, echo=FALSE, include=TRUE}
recodes_bili

```

```{r echo=FALSE, warning=FALSE, include=TRUE}
# var = los_d
# strata = diagnosis (could be none)
# fig_num
# fig_name
title = "CDF of Length of Stay for Bilirubin (mg/dL)"
subtitle = "MELD-XI Score"
caption = "ISHLT 2020"
lab_x = "Bilirubin (mg/dL)"
lab_y = "Proportion of Patients"
leg_pos = c(0.8, 0.2)

ggplot(patients, aes(BILI_TOTAL_MG_DL)) + stat_ecdf(pad = FALSE) +
  theme_bw() + geom_vline(xintercept=0.7, linetype="dashed") +
  labs(title = title,
       subtitle = subtitle,
       caption = caption,
       x = lab_x,
       y = lab_y
       ) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = leg_pos,
        legend.background = element_rect(color = "black"))

rm(caption)
rm(lab_x)
rm(lab_y)
rm(leg_pos)
rm(subtitle)
rm(title)


```

## Examing Relationship

```{r echo=FALSE, warning=FALSE, include=TRUE}
scat_plot <- patients %>% 
  # let the x-axis be the log income variable
  # let the y-axis be the life expectancy variable
  ggplot(aes(x = CREAT_MG_DL, y = BILI_TOTAL_MG_DL)) 

scat_plot+geom_point( shape = 21,
    col = 'black',
    fill = 'grey80') + theme_bw() +  labs(
    # set the x-axis label
    x = 'Creatinine (mg/dL)',
    # set the y-axis label
    y = 'Bilirubin (mg/dL)'
  )
```

## Both Bilirubin and Creatinine

There are 592 patients that have a value for both Bilirubin (mg/dL) and Creatinine (mg/dL) 

## Dialysis Patients

Patients that have dialysis will have creatinine (mg/dL) set to 4. There are 36 patients.

```{r echo=FALSE, warning=FALSE, include=FALSE}
describe(patients$EVENT_HOSP_DIALYSIS) 
```

## MELD-XI Score

```{r echo=FALSE, warning=FALSE, include=TRUE}
title = "CDF of MELD-XI Score"
subtitle = "MELD-XI Score"
caption = "ISHLT 2020"
lab_x = "MELD-XI Score"
lab_y = "Proportion of Patients"
leg_pos = c(0.8, 0.2)

ggplot(patients, aes(MELD_XI_SCORE)) + stat_ecdf(pad = FALSE) +
  theme_bw() + geom_vline(xintercept=0.7, linetype="dashed") +
  labs(title = title,
       subtitle = subtitle,
       caption = caption,
       x = lab_x,
       y = lab_y
       ) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = leg_pos,
        legend.background = element_rect(color = "black"))

rm(caption)
rm(lab_x)
rm(lab_y)
rm(leg_pos)
rm(subtitle)
rm(title)
```

```{r echo=FALSE, warning=FALSE, include=FALSE}

glimpse(patients)
surv_object = Surv(as.numeric(patients$int_dpt),as.numeric(patients$dead_pt))

surv_object

library(DiagrammeR)
library(haven)
library(arsenal)
library(KableOne)
library(tidyverse)
library(Hmisc)
library(kableExtra)
library(survival)
library(survminer)
library(dplyr)


fit1 <- survfit(surv_object ~ GROUP, data = patients)
summary(fit1)


#This problem was fun
kbl1 <- patients %>%
  # select and label columns for analysis
  select_labelled(
    CREAT_MG_DL = 'Creatinine',
    GROUP = "MELD-XI Group",
    BILI_TOTAL_MG_DL= "Bilirubin"
    
  ) %>% 
  # continuous variables need units (I always forget these)
  set_variable_units(
    CREAT_MG_DL = 'mg/dL',
    BILI_TOTAL_MG_DL = 'mg/dL'
    
  ) %>%
  KableOne::tibble_one(
    strat = 'GROUP',
    include.pval = FALSE,
    include.freq = TRUE
  )

kbl1

kibble_one(
  object = kbl1, 
  format = 'html',
  use.groups = TRUE) %>% 
  kable_styling(
    bootstrap_options = c('striped','hover')
  )

```
